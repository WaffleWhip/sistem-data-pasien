<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - HealthCure</title>
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container" style="justify-content: space-between;">
      <a href="/dashboard" class="navbar-brand">
        <img src="/logo.svg" alt="HealthCure" style="width: 40px; height: 40px;">
        <span class="brand-text"><span class="brand-health">Health</span><span class="brand-cure">Cure</span></span>
      </a>
      
      <div class="navbar-user">
        <!-- Notification Bell -->
        <div class="notification-bell user-only" onclick="app.toggleNotificationDropdown()">
          <div class="bell-icon">
            <i class="fas fa-bell"></i>
          </div>
          <span class="badge-count" id="notif-badge" style="display: none;">0</span>
          <div class="notification-dropdown" id="notif-dropdown">
            <div class="notification-header">
              <span>Notifikasi</span>
            </div>
            <div class="notification-list" id="notif-dropdown-list">
              <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <p>Tidak ada notifikasi</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="user-info">
          <div class="user-name" id="navbar-user-name">Loading...</div>
          <div class="user-role" id="navbar-user-role">-</div>
        </div>
        <div class="user-avatar" id="navbar-user-avatar">-</div>
      </div>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="layout">
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a href="/dashboard" class="sidebar-link active">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </a>
        
        <!-- Admin Menu -->
        <div class="admin-only hidden">
          <a href="/referrals" class="sidebar-link">
            <i class="fas fa-clipboard-list"></i>
            Rujukan Pasien
          </a>
          
          <div class="sidebar-section">
            <h6 class="sidebar-section-title">Data</h6>
          </div>
          <a href="/patients" class="sidebar-link">
            <i class="fas fa-users"></i>
            Data Pasien
          </a>
          <a href="/doctors" class="sidebar-link">
            <i class="fas fa-user-md"></i>
            Data Dokter
          </a>
        </div>
        
        <!-- User Menu -->
        <div class="user-only hidden">
          <div class="sidebar-section">
            <h6 class="sidebar-section-title">Kunjungan</h6>
          </div>
          <a href="/my-visits" class="sidebar-link">
            <i class="fas fa-calendar-check"></i>
            Kunjungan Saya
          </a>
          <a href="/doctors-list" class="sidebar-link">
            <i class="fas fa-user-md"></i>
            Daftar Dokter
          </a>
        </div>
        
        <div class="sidebar-section">
          <h6 class="sidebar-section-title">Akun</h6>
        </div>
        <a href="/profile" class="sidebar-link">
          <i class="fas fa-user-circle"></i>
          Profil Saya
        </a>
        
        <div class="sidebar-logout">
          <a href="#" class="sidebar-link" onclick="app.logout(); return false;">
            <i class="fas fa-sign-out-alt"></i>
            Log Out
          </a>
        </div>
      </nav>
    </aside>
    
    <main class="main-content">
      <!-- Welcome Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">Selamat Datang, <span id="welcome-name">User</span>!</h1>
          <p class="page-subtitle">Dashboard Sistem Data Pasien HealthCure</p>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <h3 id="stat-patients">0</h3>
            <p>Total Pasien</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon gold">
            <i class="fas fa-user-md"></i>
          </div>
          <div class="stat-content">
            <h3 id="stat-doctors">0</h3>
            <p>Total Dokter</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon green">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <h3 id="current-date">-</h3>
            <p>Tanggal Hari Ini</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon purple">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3 id="current-time">-</h3>
            <p>Waktu Sekarang</p>
          </div>
        </div>
      </div>
      
      <!-- Bind Requests Notification (for users) -->
      <div id="bind-requests-container" class="hidden mb-4">
        <div class="card" style="border: 2px solid var(--warning);">
          <div class="card-header" style="background: rgba(245, 158, 11, 0.1);">
            <h3><i class="fas fa-bell text-warning"></i> Permintaan Hubungkan Data Pasien</h3>
          </div>
          <div class="card-body" id="bind-requests-list">
            <!-- Bind requests will be loaded here -->
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h3><i class="fas fa-bolt"></i> Aksi Cepat</h3>
        </div>
        <div class="card-body">
          <div class="flex gap-3" style="flex-wrap: wrap;">
            <!-- Admin Actions -->
            <a href="/patients" class="btn btn-primary admin-only">
              <i class="fas fa-users"></i>
              Lihat Data Pasien
            </a>
            <a href="/doctors" class="btn btn-gold admin-only">
              <i class="fas fa-user-md"></i>
              Lihat Data Dokter
            </a>
            <button class="btn btn-success admin-only" onclick="window.location.href='/patients'">
              <i class="fas fa-plus"></i>
              Tambah Pasien Baru
            </button>
            <button class="btn btn-secondary admin-only" onclick="window.location.href='/doctors'">
              <i class="fas fa-plus"></i>
              Tambah Dokter Baru
            </button>
            
            <!-- User Actions -->
            <a href="/my-visits" class="btn btn-primary user-only">
              <i class="fas fa-calendar-check"></i>
              Kunjungan Saya
            </a>
            <a href="/doctors-list" class="btn btn-gold user-only">
              <i class="fas fa-user-md"></i>
              Daftar Dokter
            </a>
            <a href="/profile" class="btn btn-secondary user-only">
              <i class="fas fa-user-circle"></i>
              Profil Saya
            </a>
          </div>
        </div>
      </div>
      
      <!-- Info Cards -->
      <div class="stats-grid">
        <div class="card">
          <div class="card-body">
            <h4><i class="fas fa-info-circle text-accent"></i> Tentang Sistem</h4>
            <p class="text-muted mt-2" style="font-size: 0.875rem; line-height: 1.6;">
              HealthCure adalah sistem manajemen data pasien yang dirancang untuk memudahkan 
              pengelolaan informasi pasien dan dokter di klinik Anda. Sistem ini dilengkapi 
              dengan fitur keamanan JWT dan kontrol akses berbasis role.
            </p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-body">
            <h4><i class="fas fa-shield-alt text-success"></i> Keamanan</h4>
            <p class="text-muted mt-2" style="font-size: 0.875rem; line-height: 1.6;">
              <strong>Admin:</strong> Dapat melakukan semua operasi CRUD pada data pasien dan dokter.<br>
              <strong>User/Pasien:</strong> Hanya dapat melihat dan mengupdate data milik sendiri.
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/app.js"></script>
  <script>
    // Check authentication
    (async () => {
      const user = await app.checkAuth();
      if (user) {
        app.updateNavbarUser(user);
        app.updateUIForRole(user);
        document.getElementById('welcome-name').textContent = user.name;
        loadStats();
        
        // Load notifications for non-admin users
        if (user.role !== 'admin') {
          app.loadNotifications();
          loadBindRequests();
        }
      }
    })();
    
    // Load bind requests
    async function loadBindRequests() {
      try {
        const response = await app.apiRequest('/api/patients/my-bind-requests');
        if (response.success && response.data.length > 0) {
          const container = document.getElementById('bind-requests-container');
          const list = document.getElementById('bind-requests-list');
          
          container.classList.remove('hidden');
          list.innerHTML = response.data.map(patient => `
            <div style="background: var(--gray-50); border-radius: var(--radius); padding: 1rem; margin-bottom: 0.75rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                  <strong>${patient.name}</strong>
                  <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
                    HP: ${patient.phone} | Email: ${patient.email || '-'}
                  </p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-success btn-sm" onclick="approveBindRequest('${patient._id}')">
                    <i class="fas fa-check"></i> Terima
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="rejectBindRequest('${patient._id}')">
                    <i class="fas fa-times"></i> Tolak
                  </button>
                </div>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading bind requests:', error);
      }
    }
    
    // Approve bind request
    async function approveBindRequest(patientId) {
      try {
        app.showLoading();
        const response = await app.apiRequest('/api/patients/bind-request/approve', {
          method: 'POST',
          body: JSON.stringify({ patientId })
        });
        
        if (response.success) {
          app.showToast('Data pasien berhasil dihubungkan!', 'success');
          // Refresh page to update patientId in token
          setTimeout(() => window.location.reload(), 1000);
        }
      } catch (error) {
        app.showToast(error.message, 'error');
      } finally {
        app.hideLoading();
      }
    }
    
    // Reject bind request
    async function rejectBindRequest(patientId) {
      const confirmed = await app.showConfirm('Tolak Permintaan', 'Apakah Anda yakin ingin menolak permintaan binding ini?');
      if (!confirmed) return;
      
      try {
        app.showLoading();
        const response = await app.apiRequest('/api/patients/bind-request/reject', {
          method: 'POST',
          body: JSON.stringify({ patientId })
        });
        
        if (response.success) {
          app.showToast('Permintaan ditolak', 'success');
          loadBindRequests();
        }
      } catch (error) {
        app.showToast(error.message, 'error');
      } finally {
        app.hideLoading();
      }
    }
    
    // Load statistics
    async function loadStats() {
      try {
        const response = await app.apiRequest('/api/stats');
        if (response.success) {
          document.getElementById('stat-patients').textContent = response.data.totalPatients;
          document.getElementById('stat-doctors').textContent = response.data.totalDoctors;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Update date and time
    function updateDateTime() {
      const now = new Date();
      document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      document.getElementById('current-time').textContent = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>
</body>
</html>

