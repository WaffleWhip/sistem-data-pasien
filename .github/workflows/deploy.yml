name: Build and Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: healthcure-rg
  CONTAINER_ENV: healthcure-env
  LOCATION: eastasia

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get ACR credentials
      id: acr
      run: |
        ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query '[0].name' -o tsv)
        echo "name=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "server=${ACR_NAME}.azurecr.io" >> $GITHUB_OUTPUT
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query 'passwords[0].value' -o tsv)
        echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

    - name: Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.acr.outputs.server }}
        username: ${{ steps.acr.outputs.username }}
        password: ${{ steps.acr.outputs.password }}

    - name: Build and push images
      run: |
        ACR_SERVER=${{ steps.acr.outputs.server }}
        
        docker build -t ${ACR_SERVER}/healthcure-auth-service:latest ./auth-service
        docker push ${ACR_SERVER}/healthcure-auth-service:latest
        
        docker build -t ${ACR_SERVER}/healthcure-main-service:latest ./main-service
        docker push ${ACR_SERVER}/healthcure-main-service:latest
        
        docker build -t ${ACR_SERVER}/healthcure-frontend:latest ./frontend
        docker push ${ACR_SERVER}/healthcure-frontend:latest

    - name: Update Container Apps
      run: |
        ACR_SERVER=${{ steps.acr.outputs.server }}
        
        az containerapp update \
          --name healthcure-auth \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${ACR_SERVER}/healthcure-auth-service:latest
        
        az containerapp update \
          --name healthcure-main \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${ACR_SERVER}/healthcure-main-service:latest
        
        az containerapp update \
          --name healthcure-frontend \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${ACR_SERVER}/healthcure-frontend:latest

    - name: Get Frontend URL
      run: |
        URL=$(az containerapp show --name healthcure-frontend --resource-group ${{ env.RESOURCE_GROUP }} --query 'properties.configuration.ingress.fqdn' -o tsv)
        echo "ðŸš€ Deployed to: https://$URL"
